# Vercel Environment Setup Guide

## Overview

This guide provides step-by-step instructions for setting up environment variables in Vercel for both simple and full deployments of the NGSRN website.

## Table of Contents

1. [Prerequisites](#prerequisites)
2. [Simple Deployment Setup](#simple-deployment-setup)
3. [Full Deployment Setup](#full-deployment-setup)
4. [Vercel Dashboard Configuration](#vercel-dashboard-configuration)
5. [CLI Configuration](#cli-configuration)
6. [Verification and Testing](#verification-and-testing)
7. [Troubleshooting](#troubleshooting)

## Prerequisites

### Required Tools
- [Vercel CLI](https://vercel.com/cli) installed globally
- Git repository with your project
- Vercel account

### Installation
```bash
# Install Vercel CLI
npm install -g vercel

# Login to Vercel
vercel login

# Navigate to your project directory
cd ngsrn-website

# Link project to Vercel (first time only)
vercel link
```

## Simple Deployment Setup

### Step 1: Prepare Environment Configuration

```bash
# Generate simple deployment configuration
npm run env:prepare:simple

# This creates .env.simple with default values
```

### Step 2: Set Required Variables in Vercel Dashboard

1. **Go to Vercel Dashboard**
   - Visit [vercel.com/dashboard](https://vercel.com/dashboard)
   - Select your project

2. **Navigate to Environment Variables**
   - Click "Settings" tab
   - Click "Environment Variables" in sidebar

3. **Add Required Variables**

   | Variable Name | Value | Environment |
   |---------------|-------|-------------|
   | `NEXT_PUBLIC_SITE_NAME` | `NextGen Sustainable Research Network` | Production |

   **Note**: `NEXT_PUBLIC_BASE_URL` will be auto-generated by Vercel

4. **Add Feature Flags**

   | Variable Name | Value | Environment |
   |---------------|-------|-------------|
   | `NEXT_PUBLIC_ENABLE_CMS` | `false` | Production |
   | `NEXT_PUBLIC_ENABLE_AUTH` | `false` | Production |
   | `NEXT_PUBLIC_ENABLE_SEARCH` | `false` | Production |
   | `NEXT_PUBLIC_ENABLE_AI` | `false` | Production |
   | `NEXT_PUBLIC_ENABLE_MEDIA` | `false` | Production |

### Step 3: Optional Variables (Simple Deployment)

Add these if you want analytics tracking:

| Variable Name | Value | Environment |
|---------------|-------|-------------|
| `NEXT_PUBLIC_GA_ID` | `G-XXXXXXXXXX` | Production |

### Step 4: Deploy

```bash
# Deploy to production
vercel --prod

# Or use the deployment script
npm run deploy:simple
```

## Full Deployment Setup

### Step 1: Prepare Environment Configuration

```bash
# Generate full deployment configuration
npm run env:prepare:full

# This creates .env.full with all required variables
```

### Step 2: Set Up External Services

Before configuring Vercel, set up these external services:

#### Database (Supabase Recommended)
1. Create account at [supabase.com](https://supabase.com)
2. Create new project
3. Get connection strings from Settings → Database
4. Note down:
   - `DATABASE_URL` (connection pooling)
   - `DIRECT_URL` (direct connection)

#### Authentication Secret
```bash
# Generate secure secret
openssl rand -base64 32

# Or use Node.js
node -e "console.log(require('crypto').randomBytes(32).toString('hex'))"
```

#### Optional Services
- **Google Analytics**: Get measurement ID from GA4 dashboard
- **Google AI**: Get API key from [Google AI Studio](https://makersuite.google.com)
- **AWS S3**: Create IAM user with S3 permissions
- **Redis**: Get connection string from provider
- **Elasticsearch**: Get connection string from provider

### Step 3: Set Variables in Vercel Dashboard

#### Required Variables

| Variable Name | Value | Environment | Notes |
|---------------|-------|-------------|-------|
| `NEXT_PUBLIC_SITE_NAME` | `NextGen Sustainable Research Network` | Production | Your site name |
| `DATABASE_URL` | `postgresql://user:pass@host:5432/db` | Production | From Supabase |
| `DIRECT_URL` | `postgresql://user:pass@host:5432/db` | Production | From Supabase |
| `NEXTAUTH_SECRET` | `your-32-character-secret` | Production | Generated secret |

**Note**: `NEXT_PUBLIC_BASE_URL` and `NEXTAUTH_URL` will be auto-generated by Vercel

#### Feature Flags (Full Deployment)

| Variable Name | Value | Environment |
|---------------|-------|-------------|
| `NEXT_PUBLIC_ENABLE_CMS` | `true` | Production |
| `NEXT_PUBLIC_ENABLE_AUTH` | `true` | Production |
| `NEXT_PUBLIC_ENABLE_SEARCH` | `true` | Production |
| `NEXT_PUBLIC_ENABLE_AI` | `true` | Production |
| `NEXT_PUBLIC_ENABLE_MEDIA` | `true` | Production |

#### Optional Variables

| Variable Name | Value | Environment | Required For |
|---------------|-------|-------------|--------------|
| `NEXT_PUBLIC_GA_ID` | `G-XXXXXXXXXX` | Production | Analytics |
| `GEMINI_API_KEY` | `AIzaSyC...` | Production | AI features |
| `AWS_ACCESS_KEY_ID` | `AKIAIOSFODNN7EXAMPLE` | Production | Media storage |
| `AWS_SECRET_ACCESS_KEY` | `wJalrXUtnFEMI/K7MDENG...` | Production | Media storage |
| `AWS_S3_BUCKET` | `ngsrn-media-bucket` | Production | Media storage |
| `REDIS_URL` | `redis://user:pass@host:6379` | Production | Caching |
| `ELASTICSEARCH_URL` | `https://user:pass@host:9200` | Production | Search |

### Step 4: Deploy

```bash
# Deploy to production
vercel --prod

# Or use the deployment script
npm run deploy:full
```

## Vercel Dashboard Configuration

### Adding Variables via Dashboard

1. **Access Environment Variables**
   ```
   Vercel Dashboard → Your Project → Settings → Environment Variables
   ```

2. **Add New Variable**
   - Click "Add New" button
   - Enter variable name (e.g., `NEXT_PUBLIC_SITE_NAME`)
   - Enter variable value
   - Select environment: `Production`
   - Click "Save"

3. **Bulk Import (Optional)**
   - Click "Import" button
   - Paste multiple variables in format:
     ```
     NEXT_PUBLIC_SITE_NAME=NextGen Sustainable Research Network
     DATABASE_URL=postgresql://user:pass@host:5432/db
     ```

### Environment Selection

- **Production**: Used for `vercel --prod` deployments
- **Preview**: Used for pull request deployments
- **Development**: Used for `vercel dev` local development

**Recommendation**: Set all variables for Production environment initially.

## CLI Configuration

### Using Vercel CLI

```bash
# Add single variable
vercel env add NEXT_PUBLIC_SITE_NAME production
# Enter value when prompted

# Add multiple variables
vercel env add DATABASE_URL production
vercel env add NEXTAUTH_SECRET production

# List all environment variables
vercel env ls

# Remove variable
vercel env rm VARIABLE_NAME production
```

### Bulk Configuration Script

Create a script to set multiple variables:

```bash
#!/bin/bash
# setup-vercel-env.sh

echo "Setting up Vercel environment variables..."

# Required variables
vercel env add NEXT_PUBLIC_SITE_NAME production
vercel env add DATABASE_URL production
vercel env add DIRECT_URL production
vercel env add NEXTAUTH_SECRET production

# Feature flags
vercel env add NEXT_PUBLIC_ENABLE_CMS production
vercel env add NEXT_PUBLIC_ENABLE_AUTH production
vercel env add NEXT_PUBLIC_ENABLE_SEARCH production
vercel env add NEXT_PUBLIC_ENABLE_AI production
vercel env add NEXT_PUBLIC_ENABLE_MEDIA production

echo "Environment variables setup complete!"
```

```bash
# Make executable and run
chmod +x setup-vercel-env.sh
./setup-vercel-env.sh
```

## Verification and Testing

### Step 1: Validate Configuration

```bash
# Validate environment variables
npm run env:validate

# Check feature flags
npm run env:check-flags

# Validate build environment
npm run build:validate
```

### Step 2: Test Local Development

```bash
# Pull Vercel environment variables to local
vercel env pull .env.local

# Test with Vercel development server
vercel dev

# Test build locally
npm run build
```

### Step 3: Verify Deployment

```bash
# Deploy and check logs
vercel --prod

# View deployment logs
vercel logs [deployment-url]

# Check deployment status
vercel ls
```

### Step 4: Test Application Features

After deployment, test these features based on your deployment phase:

#### Simple Deployment
- [ ] Website loads correctly
- [ ] Navigation works
- [ ] Pages render properly
- [ ] Analytics tracking (if configured)

#### Full Deployment
- [ ] All simple deployment features
- [ ] User authentication works
- [ ] CMS is accessible
- [ ] Search functionality works
- [ ] AI features respond
- [ ] Media uploads work (if configured)

## Troubleshooting

### Common Issues and Solutions

#### 1. Build Fails with Missing Variables

**Error**: `Environment variable NEXT_PUBLIC_SITE_NAME is not defined`

**Solution**:
```bash
# Check what variables are set
vercel env ls

# Add missing variable
vercel env add NEXT_PUBLIC_SITE_NAME production

# Redeploy
vercel --prod
```

#### 2. Variables Not Taking Effect

**Error**: Old values still being used after updating

**Solution**:
```bash
# Clear Vercel cache
vercel --prod --force

# Or delete and recreate deployment
vercel rm [deployment-url]
vercel --prod
```

#### 3. Auto-Generated URLs Not Working

**Error**: `NEXT_PUBLIC_BASE_URL` conflicts with Vercel URL

**Solution**:
```bash
# Remove manual NEXT_PUBLIC_BASE_URL setting
vercel env rm NEXT_PUBLIC_BASE_URL production

# Let Vercel auto-generate from VERCEL_URL
vercel --prod
```

#### 4. Database Connection Issues

**Error**: Database connection fails in production

**Solution**:
1. Verify `DATABASE_URL` is correct
2. Check database allows connections from Vercel IPs
3. Ensure `DIRECT_URL` is set for migrations
4. Test connection string locally:
   ```bash
   # Test database connection
   npm run db:test-connection
   ```

#### 5. Authentication Not Working

**Error**: NextAuth.js authentication fails

**Solution**:
1. Verify `NEXTAUTH_SECRET` is set and secure (32+ characters)
2. Check `NEXTAUTH_URL` matches deployment URL
3. Ensure authentication is enabled:
   ```bash
   vercel env add NEXT_PUBLIC_ENABLE_AUTH true production
   ```

#### 6. Feature Flags Not Working

**Error**: Features enabled/disabled incorrectly

**Solution**:
```bash
# Check current feature flags
npm run env:check-flags

# Reset to correct phase
npm run env:prepare:simple  # or :full
vercel --prod
```

### Debug Commands

```bash
# Check environment variables in deployment
vercel logs --follow

# Test environment locally
vercel dev

# Validate specific configuration
NEXT_PUBLIC_ENABLE_CMS=true npm run build:validate

# Check Vercel project settings
vercel inspect [deployment-url]
```

### Getting Help

1. **Check deployment logs**: `vercel logs [deployment-url]`
2. **Validate environment**: `npm run build:validate`
3. **Test locally**: `vercel dev`
4. **Review Vercel documentation**: [vercel.com/docs](https://vercel.com/docs)
5. **Check project settings**: Vercel Dashboard → Project → Settings

## Quick Reference Commands

```bash
# Setup
vercel login
vercel link
npm run env:prepare:simple  # or :full

# Configuration
vercel env add VARIABLE_NAME production
vercel env ls
vercel env pull .env.local

# Deployment
vercel --prod
npm run deploy:simple  # or :full

# Validation
npm run env:validate
npm run build:validate
vercel logs [deployment-url]

# Troubleshooting
vercel --prod --force
vercel dev
npm run env:check-flags
```